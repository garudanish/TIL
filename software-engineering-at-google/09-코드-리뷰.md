# Chapter 09. 코드 리뷰

- 코드 리뷰는 작성자 이외의 사람이 코드를 검토하는 프로세스로, 주로 코드를 코드베이스에 반영하기 전에 수행한다.
- 코드 리뷰를 효과적으로 하려면 일반적으로 절차와 지원 도구를 잘 활용해야 한다.
- 확실한 이점('버그가 코드 베이스로 침투하기 전에 잡아낸다')과 미묘한 이점들을 제공한다.

## 9.1 코드 리뷰 흐름

- 코드 리뷰는 커밋 직전 등 소프트웨어 개발 단계 곳곳에서 이루어질 수 있다.
- 구글의 코드 리뷰는 보통 다음 절차대로 진행된다.
  1. 작성자가 변경 사항을 작성하고, 스냅샷을 만들어 코드베이스와의 diff를 뜬다.
  2. 작성자는 초기 패치를 사용해 자동 리뷰 의견을 받거나 스스로 리뷰를 해본다.
  3. 리뷰어들은 코드 리뷰 도구에서 diff에 댓글로 의견을 남긴다.
  4. 작성자는 피드백을 기초로 변경을 수정하고 새로운 스냅샷을 업로드한 후 리뷰어들에게 회신한다. (iii, iv단계는 여러 차례 반복될 수 있다.)
  5. 리뷰어들이 변경 내용에 모두 만족하면 LGTM 태그를 달아준다.
  6. 변경에 LGTM이 달리고, 모든 댓글을 해결하고, 변경이 승인되면, 작성자는 코드베이스에 커밋할 수 있다.

> - 코드는 그 자체로 부채임을 인정하고 잊지 말아야 한다
> - 새로운 기능 개발을 시작하기 앞서 정말 새로운 기능이 맞는지를 주의 깊게 살펴야 한다.
> - 이상적으로는 중복 확인이 먼저 이루어져야 하고, 무엇이 됐든 새로운 걸 설계할 때는 코드 작성 전에 관련 그룹과 대화를 나눠봐야 한다.
> - 코드 리뷰는 전에 내린 설계를 번복하거나 재논의하는 자리여서는 안 된다.

## 9.2 코드 리뷰 @ 구글

- 구글에서는 어떤 변경이든 '승인'을 얻으려면 세 가지 측면에서의 리뷰를 통과해야 한다.
  1. 다른 엔지니어로부터 정확성*correctness*과 이해 용이성*comprehension*을 평가받는다.
  2. 변경되는 코드 영역을 관리하는 코드 소유자*code owner*로부터 변경 코드가 적절하다는 승인을 받는다.
  3. 누군가로부터 가독성 승인을 받는다.
- 대부분의 리뷰는 세 역할을 모두 수행할 수 있는 사람 한 명이 처리하기 때문에 이 절차들이 빠르게 진행된다.
- 승인을 두 개 이상 언어야 하는 코드 리뷰 대부분은 두 단계로 진행된다.
  1. 동료 엔지니어로부터 LGTM을 받는다.
     1. 동료 엔지니어는 코드가 정확한지와 변경된 코드가 유효한지에 집중한다.
  2. 해당 코드 소유자와 가독성 인증자에게 승인을 요청한다.
     1. 코드 소유자는 자신이 맡은 코드베이스에 적합한 변경인지에 집중한다.
- 세 가지 역할을 나눔으로써 코드 리뷰 프로세스를 더 유연하게 운영할 수 있다.

## 9.3 코드 리뷰의 이점

- 소프트웨어 업계에서 코드 리뷰가 필요하다는 데는 논란의 여지가 없지만 구체적인 모습은 아주 제각각이다.
- 코드 리뷰는 구글의 소프트웨어 엔지니어 모두가 반드시 따라야 하는 몇 안 되는 전사적인 프로세스다.
- 잘 설계된 코드 리뷰 프로세스와 코드 리뷰를 중요하게 다루는 문화가 주는 대표적인 이점은 다음과 같다.
  1. 코드가 정확한지 확인해준다
  2. 변경된 코드를 다른 엔지니어도 잘 이해한다
  3. 코드베이스가 일관되게 관리된다
  4. 팀이 소유권(주인의식)을 더 강하게 느낀다
  5. 지식이 공유된다
  6. 코드 리뷰 자체의 기록이 남는다

### 9.3.1 코드 정확성

- 리뷰어는 일차적으로 변경된 코드의 '정확성'을 확인해주며, 코드 리뷰가 주는 가장 확실한 이점이다.
- 코드 리뷰에 들이는 시간은 테스트, 디버그, 회귀 테스트에 투입되는 시간을 줄여준다.
- 리뷰어는 자신이 선호한다는 이유로 다른 안을 주장해서는 안 된다.
- 정적 분석이나 자동화 테스트 등을 활용해 많은 정확성 검사를 자동으로 수행할 수 있다.
- 도구의 힘은 커졌지만 초기 코드 리뷰 프로세스에서 결함을 찾는 일은 여전히 원점 회귀 전략에 필수다.
- 코드 리뷰는 소프트웨어 개발에서 결함에 대처하는 여러 방어 수단 중 한 축이다.

### 9.3.2 코드 이해 용이성

- 코드 리뷰는 주어진 변경이 수많은 다른 사람에게도 쉽게 이해되는지를 평가하는 첫 번째 시험대이다.
- 리뷰어는 작성자가 선택한 설계를 존중해야 한다. 하지만 그와 별개로 코드가 잘 이해되지 않으면 질문을 던져보는 건 좋다.

### 9.3.3 코드 일관성

- 리뷰어는 코드 리뷰 과정에서 주어진 코드가 코드베이스의 표준을 얼마나 잘 따르는가를 평가할 수 있다.
- 가독성 승인자의 임무는 주어진 코드가 다음 사항들을 잘 만족하는지를 검토하는 것이다.
  1. 해당 프로그래밍 언어의 모범 사례들을 잘 따라야 한다
  2. 구글 코드 리포지터리에서 같은 언어로 작성된 다른 코드들과 일관되어야 한다
  3. 필요 이상으로 복잡하지 않아야 한다
- 코드는 일관되고 단순해야지 사람들이 쉽게 이해할 수 있고 리팩터링 도구가 더 쉽게 다룰 수 있다.
- 코드베이스 전체의 코드를 일관되게 관리하면 모든 엔지니어의 이해도가 향상되고, 코드 리뷰 프로세스에도 긍정적인 영향을 준다.
- 코드베이스가 일관되면 다른 팀의 프로젝트 코드도 한결 수월하게 리뷰할 수 있다.

### 9.3.4 심리적, 문화적 이점

- 코드 리뷰는 소프트웨어 엔지니어에게 코드는 '자신의 것'이 아니라 협업을 통해 만들어지는 '조직의 공동 소유물'임을 인식시켜준다.
- 코드 리뷰는 비판적 피드백으로 인한 감정적으로 번질 수 있는 논쟁을 건전하게 만들어준다.
- 코드 리뷰는 개발자의 작업 결과를 검증하고 인정해주는 효과가 있다.
- 코드 리뷰를 필수로 못박으면 작성자들에게 자신의 코드를 한번 더 들여다보게 하는 효과가 있다.

### 9.3.5 지식 공유

- 리뷰 프로세스는 제안, 신기술 소개, 조언을 통해 리뷰어가 변경 작성자에게 도메인 지식을 전파하도록 이끌어준다.
- 많은 코드 리뷰에서 양방향 정보 교환이 이루어진다.
- 코드 리뷰를 통해 곧바로 적용할 수 있는 지식을 적시에 전달할 수 있다.
- 코드 리뷰 프로세스는 소프트웨어 엔지니어들이 서로 교류하며 코딩 기법 정보를 교환하는 주된 수단이다.
- 코드 리뷰는 코드베이스의 변경 이력을 기록하는 역할도 한다.

## 9.4 코드 리뷰 모범 사례

- 대다수 모범 사례는 코드 리뷰를 무리 없이 확장할 수 있도록 프로세스를 날렵하게 유지하는 게 중요하다고 강조한다.

### 9.4.1 공손하고 전문가답게

- 어떤 피드백과 비평이라도 전문가답게 건네는 일이 중요하다.
- 리뷰어들은 작성자가 선택한 방식을 존중하고 오직 그 방식에 결함이 있을 때만 대안을 제시해야 한다.
- 리뷰어는 신속하게(대체로 24시간 이내) 피드백 해야 한다.
- 너무 단편적인 피드백은 삼가야 한다.
- 리뷰어에게 전문가다움을 기대하는 만큼 작성자에게도 전문가다움이 요구된다.
- 코드 리뷰 과정에서 리뷰어가 단 댓글은 모두 할일*TODO item*로 취급해야 한다.
- 본인의 팀이 소유한 코드베이스를 외부의 누군가가 변경하려는 경우에도 제안자의 견해에 수용적인 자세로 응해야 한다.

### 9.4.2 작게 변경하기

- 코드 리뷰는 단 하나의 문제만을 다루는 게 가장 이상적이다.
- 큰 변경을 무조건 피할 수는 없으므로, 프로세스를 작은 변경에 적합하게끔 최적화하는 동시에 가끔 일어나는 큰 변경도 수용할 수 있게 하면 좋다.
- '작은' 변경은 일반적으로 변경되는 코드가 약 200줄 이하라는 뜻이다.
- 변경이 작다면 리뷰어들도 승인 여부를 더 신속하게 판단할 수 있다.

### 9.4.3 변경 설명 잘쓰기

- 변경 설명의 첫 줄은 어떤 종류의 변경인지를 잘 요약해야 한다.
- 구체적으로 무엇을 왜 변경하는지 알려주는 자세한 설명 역시 필요하다.
- 공개 API 설명에서 내부 구현 방식까지 드러내는 건 옳지 않지만 코드 안에는 설명을 달아줘야 한다.

### 9.4.4 리뷰어는 최소한으로

- 리뷰어를 추가해서 얻는 가치보다 비용이 훨씬 빠르게 증가한다.
- 여러 리뷰어들이 함께 진행할 경우 서로 다른 관점에서 바라보도록 역할을 조율한 후 진행해야 한다.

### 9.4.5 가능한 한 자동화하기

- 코드 리뷰는 사람이 주는 피드백이 중요하지만, 자동화할 수 있는 요소가 있다면 자동화하면 좋다.

## 9.5 코드 리뷰 유형

### 9.5.1 그린필드 코드 리뷰

- 완전히 새로운 코드를 대상으로 하는 가장 드문 유형의 코드 리뷰다.
- 코드가 지속 가능함을 보장하려면 AP가 합의된 설계에 부합하고 테스트도 완벽히 이루어졌는지를 그린필드 리뷰에서 확인해야 한다.

### 9.5.2 동작 변경, 개선, 최적화

- 꼭 필요한 변경인지, 코드베이스를 개선하는지를 살펴야 한다.

### 9.5.3 버그 수정과 롤백

- 버그를 수정하면서 (기능 변경 등) 다른 문제까지 묶어 처리하고픈 마음을 눌러야 한다.
- 버그 수정 시 테스트도 보강해야 할 가능성이 크다.
- 록백도 벼경이 반영되기 전 상태로 코드를 되돌리도록 구성한 또 하나의 '변경'이다.
- 잠재적으로 롤백을 유발할 수 있는 모든 변경은 가능한 한 작고 원자적이어야 한다.

### 9.5.4 리팩터링과 대규모 변경

- 기계(도구)가 생성한 변경도 리뷰가 필요하다.
- 자동 생성된 변경이라도 리뷰어가 정확성과 적용 가능성을 확인하는 것은 똑같지만, 댓글을 다는 것은 지양한다.
- 자동 변경의 리뷰어들에게 수정 범위를 확대하지 않기를 권한다.

## 9.6 마치며

- 코드 리뷰는 엔지니어들을 이어주는 매개체이자, 테스트, 정적 분석, 지속적 통합 등 거의 모든 다른 프로세스가 엮여있는 최우선 개발 워크플로다.

## 9.7 핵심 정리

- 코드베이스 전반의 정확성, 이해 용이성, 일관성 보장 등 코드 리뷰가 주는 이점이 많다.
- 작성자의 가정에 대해 항시 다른 사람의 검토를 받도록 하고, 코드를 읽는 사람에게 최적화한다.
- 전문가다움을 지키면서 중요한 피드백을 받을 기회를 제공한다.
- 코드 리뷰는 지식을 조직 전체에 공유하는 데도 중요한 역할을 한다.
- 코드 리뷰 프로세스를 확장하려면 자동화가 아주 중요하다.
- 코드 리뷰 자체가 변경 이력이 되어준다.
