# Chapter 11. 테스트 개요

- 테스트는 초창기엔 수동으로 이루어졌고 오류가 나기 쉬운 프로세스였지만, 2000년대 초부터 개발자가 주도하는 테스트와 자동 테스트가 도입됐다.
- 자동 테스트는 버그를 이르게 잡을 수 있도록 도와준다.
- 버그 잡기 외에도 '소프트웨어가 변화할 수 있도록 지원'하는 역할도 해준다.
- 시스템을 더 많이 더 빠르게 변경하고 싶다면 더 빠르게 테스트하는 방법을 모색해야 한다.
- 테스트를 작성하는 행위가 시스템의 설계도 개선해준다.
-

## 11.1 테스트를 작성하는 이유

- 가장 단순한 테스트는 다음 요소들로 정의할 수 있다.
  - 테스트하려는 단 하나의 행위(주로 메서드나 API)
  - 특정한 입력(API에 전달하려는 값)
  - 관측 가능한 출력 혹은 동작
  - 통제된 조건(하나의 격리된 프로세스 등)
- 간단한 테스트가 수백에서 수천 개 모은 것을 테스트 스위트라고 한다.
- 테스트는 엔지니어에게 신뢰를 줄 때만 가치가 있다. 나쁜 테스트 스위트는 테스트가 아예 없는 것만 못하다.
- 테스트는 좋은 제품을 빠르게 만들 수 있게 해줄 뿐 아니라 우리 삶에서 중요한 제품과 서비스의 안전을 보장하는 데도 점점 핵심적인 역할을 하고 있다.
- 품질이 떨어지는 제품이나 서비스를 만들면 필연적으로 나쁜 결과를 초래한다.

### 11.1.1 구글 웹 서버 이야기

- 초창기 구글은 엔지니어 주도 테스트를 크게 중요하게 여기지 않았고, 구글 웹 서버는 그중 최악의 상황을 겪은 제품이다.
- 구글 웹 서버(GWS)는 구글 검색의 핵심이었지만 규모와 복잡성이 커지면서 생산성이 급격히 떨어졌다.
- GWS에 엔지니어 주도의 자동 테스트를 정책 차원에서 도입하자, 핫픽스 배포 건수가 절반으로 줄었다.
- 개별 엔지니어가 버그를 심는 빈도는 아주 낮더라도 프로젝트가 커져 팀원이 많아지면 결함 목록은 계속 길어질 것이다.
- 개별 엔지니어가 작성한 테스트를 팀이 공유하는 자원 풀에 추가하면, 팀원 모두가 공유된 테스트를 수행하고 결함을 찾아낼 수 있다.
  - 엔지니어가 디버거를 실행해 버그를 찾는 방식과 비교하면 엔지니어링 비용 차이가 크다.

### 11.1.2 오늘날의 개발 속도에 맞는 테스트

- 소프트웨어 시스템은 계속해서 더 커지고 복잡해지고 있다.
- 대부분의 소프트웨어는 기능과 지원 플랫폼이 너무 폭증해서 사람이 모든 행위를 수동으로 검증할 수 있는 한계를 넘어섰다.
  - 테스트에서의 해법은 단 하나, 바로 '자동화'뿐이다.

### 11.1.3 작성하고, 수정하고, 조치하라

- 가장 순수한 형태의 자동 테스트는 '테스트 작성', '테스트 수행', '실패한 테스트에 대한 조치'로 이루어진다.
- 오늘날 시스템의 규모와 배포 속도를 따라잡으려면 모든 엔지니어가 테스트도 함께 개발해야만 한다.
- 테스트를 작성하는 것과 ***좋은 테스트***를 작성하는 것은 별개다.
- 자동 테스트의 핵심은 같은 동작을 끊임없이 반복하는 데 있다.
- 테스트를 코드로 작성하면 다양한 환경에서 수행할 수 있도록 테스트들을 '모듈화'하기도 좋다.
- 테스트 프로세스가 얼마나 효과적이냐는 테스트 실패를 어떻게 처리하느냐에 달려 있다.
- 요약
  - 건실한 자동 테스트 문화에서는 모두가 테스트를 작성하고 공유하도록 장려한다.
  - 테스트들을 정기적으로 실행한다.
  - 테스트가 실패하면 바로 조치하도록 권장해야 테스트 프로세스를 신뢰하고 계속 이어갈 수 있다.

### 11.1.4 테스트 코드가 주는 혜택

#### 디버깅 감소

- 테스트를 한 번 작성해두면 프로젝트가 살아 있는 내내 값비싼 결함을 예방해주고 짜증 나는 디버깅에서 해방시켜주는 식으로 지속해서 혜택을 준다.

#### 자신 있게 변경

- 좋은 테스트들로 무장한 팀은 자신감을 가지고 변경들을 리뷰하고 수용할 수 있다.

#### 더 나은 문서자료

- 한 번에 하나의 행위만 집중해 검증하는 명확한 테스트는 마치 실행 가능한 문서와 같다.

#### 더 단순한 리뷰

- 정확성, 극단 상황, 오류 상황 등 다양한 측면에서 코드를 검사해주는 테스트가 준비되어 있다면 리뷰어가 변경된 코드가 제대로 작동하는지를 검증하는 시간을 크게 줄여준다.

#### 사려 깊은 설계

- 새로 작성한 코드의 테스트를 작성하는 일은 실질적으로 해당 코드의 API가 잘 설계되었는지를 시험하는 행위다.

#### 고품질의 릴리스를 빠르게

- 건실한 자동 테스트 스위트를 갖춘 팀은 새로운 버전을 릴리스하며 불안에 떨지 않는다.

## 11.2 테스트 스위트 설계하기

- 더 작은 테스트가 더 빠르고, 안정적이고, 평균적으로 고통이 적다.
- 모든 테스트 케이스에는 크기와 범위라는 두 가지 독립된 요소가 있다.
  - 크기: 테스트 케이스 하나를 실행하는데 필요한 자원. 메모리, 프로세스 시간 등.
  - 범위: 검증하려는 특정한 코드 경로.

### 11.2.1 테스트 크기

- 테스트의 크기는 어떻게 동작하고, 무엇을 하고, 얼마나 많은 자원을 소비하는지로 평가한다.
- 구글은 단위 테스트와 통합 테스트라는 전통적인 용어 대신 작은 테스트, 중간 크기 테스트, 큰 테스트라는 단어를 사용한다.
  - 범위와 상관없이 작은 테스트는 더 많은 인프라나 자원을 사용하는 테스트보다 거의 항상 더 바르고 더 결정적이다.

#### 작은 테스트

- 세 가지 테스트 중 작은 테스트는 제약이 가장 엄격하다.
- 작은 테스트의 제약들
  - 단 하나의 프로세스에서 실행되어야 한다는 것이다.
  - 네트워크와 디스크에도 접근할 수 없다.
- 제약들의 목적은 테스트를 느려지게 하거나 비결정적으로 만드는 주요 원인들로부터 작은 테스트를 떼어 놓는 것이다.

#### 중간 테스트

- 중간 크기 테스트는 여러 프로세스와 스레드를 활용할 수 있고, 로컬 호스트로의 네트워크 호출 같은 블로킹 호출도 이용할 수 있다.
- 하지만 외부 시스템과의 통신은 여전히 불허한다.
- 데이터베이스 인스턴스를 실행할 수 있으므로, 테스트 대상 코드를 더 현실적인 설정 하에서 검증할 수 있다.

#### 큰 테스트

- 테스트와 대상 시스템이 여러 대의 기기(원격 클러스터에서 구동중인 시스템 등)를 활용할 수 있다.
- 구글은 큰 테스트를 몇 가지 용도에 한정해서 활용한다.
  - 전체 시스템의 종단간*end to end* 테스트.
  - 테스트 대역을 사용하는 게 불가능한 레거시 컴포넌트를 테스트 할 때.
- 구글은 큰 테스트를 빌드나 릴리스 때만 수행되도록 해 개발 워크플로에 영향을 주지 않도록 한다.

#### 테스트 크기와 무관한 공통 특성

- 모든 테스트는 밀폐되어야 한다. 즉, 셋엄, 실행, 테어다운하는 데 필요한 모든 정보를 담고 있어야 한다.
- 테스트 수행 순서 같은 외부 환경에 관해서는 가능한 한 아무것도 가정하지 않아야 한다.
  - 예를 들어 공유 데이터베이스에 의존해서는 안 된다.
- 테스트는 확인하려는 행위를 수행하는 데 필요한 정보'만'을 포함해야 한다.
- 테스트에서는 조건문이나 순환문같은 제어문을 쓰지 않는 게 좋다.
- 테스트 코드도 누군가 읽었을 때 부끄럽지 않도록 작성해야 한다.

#### 실제 상황에서의 테스트 크기

- 테스트 크기를 명확히 정의한 덕분에 구글은 규칙을 실무에 적용할 수 있는 도구들을 만들 수 있었다.

### 11.2.2 테스트 범위

- 테스트 범위란 주어진 테스트가 얼마나 많은 코드를 검증하느냐를 말한다.
- 좁은 범위 테스트: 독립된 클래스나 메서드같이 코드베이스 중 작은 일부 로직을 검증하도록 설계된다.
- 중간 범위 테스트: 적은 수의 컴포넌트들 사이의 상호작용을 검증하도록 설계된다.
- 넓은 범위 테스트: 시스템의 서로 다른 부분들 사이의 상호작용, 혹은 클래스나 메서드 하나만 실행할 때는 괜찮다가 여럿을 조합해 실행하면 나타나는 예기치 못한 동작을 검증하도록 설계된다.
- 단위 테스트의 범위가 좁다고 할 때는 '실행'되는 코드가 아니라 '검증'되는 코드의 양이 기준이다.
- 좁은 범위 테스트는 작은 테스트가 되고 더 넓은 범위 테스트들은 중간 크기나 큰 테스트가 되는 것이 일반적이지만, 꼭 그렇지는 않다.
- 구글은 되도록 작은 테스트를 추구하며, 마찬가지로 좁은 범위 테스트를 추구한다.
  - 비즈니스 로직 대부분을 검증하는 좁은 범위의 단위 테스트가 80%, 둘 이상의 구성요소 간 상호작용을 검증하는 중간 범위의 통합 테스트가 15%, 전체 시스템을 검증하는 종단간 테스트가 5% 정도가 되도록 한다.
- 테스트 스위트 안티패턴으로 아이스크림 콘과 모래시계가 있다.
- 아이스크림 콘에서는 엔지니어들이 종단간 테스트를 많이 작성하고 통합 테스트나 단위 테스트는 훨씬 적게 작성한다.
- 모래시계는 종단간 테스트와 단위 테스트는 많지만 통합 테스트가 적다.
- 다양한 크기와 범위의 테스트가 시스템 아키텍처와 조직의 현실에 맞게끔 조화롭게 혼합되어 있다면 좋은 테스트 스위트라고 할 수 있다.

### 11.2.3 비욘세 규칙

- 깨뜨려보고 싶은 모든 것을 테스트해야 한다.
  - 성능, 행위 정확성, 접근성, 보안처럼 의심해볼 수 있는 모든 것이 다 포함된다.
  - 이를 구글에서는 '비욘세 규칙'이라고 부른다.

### 11.2.4 코드 커버리지

- 적은 수의 테스트만으로 코드 커버리지를 높이면서 의미 있는 동작은 거의 돌려보지 않을 수 있다.
- 더 큰 문제는 코드 커버리지 자체가 목표가 되기 쉽다는 현실이다.
  - 코드 커버리지를 목표로 세워두면 그 이상을 해야 할 동기가 부족해진다.
- 테스트 슽위트의 품질을 높이는 더 나은 방안은 검사해야 할 행위에 집중하는 것이다.
- 코드 커버리지는 테스트되지 않은 코드가 어디인지는 알려줄 수 있지만, 시스템이 얼마나 제대로 테스트되었느냐를 판가름하는 지표로는 적합하지 않다.

## 11.3 구글 규모의 테스트

- 구글은 모든 코드를 모노리포에서 관리하고, 매주 약 2천 5백만 라인이 변경되는 등 엔지니어링 환경이 상당히 복잡하다.

### 11.3.1 대규모 테스트 스위트의 함정

- 자동 테스트가 엉망으로 작성되어 있다면 코드를 변경하기 어렵다.
- 품질 낮은 테스트는 심지어 해당 테스트와 관련 없는 코드가 변경되어도 실패할 수 있다.
- 깨지기 쉬운 테스트를 만드는 주범으로 모의 객체 오용을 들 수 있다.
- 테스트 스위트가 커지면 수행시간이 길어진다는 점도 문제다.
- 테스트 스위트가 비결정적이고 느려지면 생산성을 갉아먹는다.
- 거대한 테스트 스위트를 잘 관리하는 비결은 테스트를 존중하는 문화다.
- 안 좋은 테스트를 만드는 실수를 줄여주는 테스트 인프라에도 투자해야 한다.

## 11.4 구글의 테스트 역사

- 자동 테스트를 전사적으로 뿌리내리게 한 원동력은 '오리엔테이션 수업', '테스트 인증 프로그램', '화장실에서도 테스트'다.

### 11.4.1 오리엔테이션 수업

- 2005년 입사 오리엔테이션부터 자동 테스트의 가치를 한시간씩 다뤘으며, 이때 모든 아이디어가 마치 구글 표준 관행인 것처럼 교육했다.
- 오리엔테이션 수업은 신규 엔지니어들이 바깥에서 배워온 테스트 지식과 경험을 구글 규모의 크고 복잡한 코드베이스에서도 잘 응용할 수 있도록 디딤돌 역할을 해준다.

### 11.4.2 테스트 인증

- 테스트 인증의 목적은 각 팀이 자신의 테스트 프로세스 수준(성숙도)을 알게 하고 (더 핵심은) 한 단계 올라서기 위한 지침을 제공하는 것이었다.

### 11.4.3 화장실에서도 테스트

- 테스트에 대한 인식을 적극적으로 높이고자 화장실의 칸칸마다 글을 붙인 게 시작이었다.

### 11.4.4 오늘날의 테스트 문화

- 구글에서는 코드를 변경할 때마다 코드 리뷰를 거쳐야 하고, 모든 변경에는 테스트 코드가 포함되어 있어야 한다.
- 시간이 흐르면서 테스트는 구글 엔지니어링 문화의 필수 요소로 자리 잡았다.
- 엔지니어들이 자신의 의지로 테스트를 작성한다는 것은 테스트가 이롭다는 생각을 완전히 받아들였다는 뜻이다.

## 11.5 자동 테스트의 한계

- 모든 종류의 테스트를 다 자동화할 수는 없다.
- 품질 평가, 창의력이 필요한 분야 등에서는 인간이 더 뛰어날 수 있다.
- 탐색적 테스팅은 기본적으로 창의력을 요구하는 작업으로, 검사 대상을 마치 고장내야 할 퍼즐로 취급한다.
  - 탐색적 테스팅으로 문제를 발견하는 즉시 자동 테스트를 추가해 문제가 재발하지 않도록 예방해야 한다.

## 11.6 마치며

- 개발자 주도 자동 테스트는 구글에서 가장 혁신적인 소프트웨어 엔지니어링 관행 중 하나였다.

## 11.7 핵심 정리

- 자동 테스트는 소프트웨어를 변경할 수 있게 해주는 토대다.
- 테스트를 확장하려면 반드시 자동화해야 한다.
- 테스트 커버리지를 건실하게 유지하려면 균형 잡힌 테스트 스위트가 필요하다.
- "네가 좋아했다면 테스트를 준비해뒀어야지."
- 조직의 테스트 문화를 바꾸는 데는 시간이 걸린다.
