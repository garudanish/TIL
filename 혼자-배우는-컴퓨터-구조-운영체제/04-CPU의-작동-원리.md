# Chapter 04. CPU의 작동 원리

## 4-1. ALU와 제어장치

### ALU

- ALU가 계산을 하기 위해서는 피연산자와 수행할 연산이 필요하다.
- ALU는 레지스터를 통해 피연산자를 받아들이고, 제어장치로부터 수행할 연산을 알려주는 제어 신호를 받아들인다.
- 연산을 수행한 결과는 특정 숫자, 문자, 메모리 주소가 될 수 있고, 이 결괏값은 일시적으로 레지스터에 저장된다.
  - CPU가 접근하는 속도가 메모리보다 레지스터에 접근할 때 더 빠르므로 레지스터에 우선 저장한다.
- ALU는 계산 결과와 더불어, 연산 결과에 대한 추가적인 정보를 내보내야 할 때 플래그를 내보낸다.
- 대표적인 플래그는 다음과 같다
  - 부호 플래그: 연산한 결과의 부호
  - 제로 플래그: 연산 결과가 0인지 여부
  - 캐리 플래그: 연산 결과 올림수나 빌림수가 발생했는지
  - 오버플로우 플래그: 오버플로우(연산 결과가 연산 결과를 담을 레지스터보다 큰 상황)가 발생했는지
  - 인터럽트 플래그: 인터럽트가 가능한지
  - 슈퍼바이저 플래그: 커널 모드로 실행 중인지, 사용자 모드로 실행 중인지
- 플래그들은 플래그 레지스터라는 레지스터에 저장된다.
- 이 외에도 ALU 내부에는 여러 계산을 위한 회로들이 있다.

### 제어장치

- 제어장치는 CPU의 구성 요소 중 가장 정교하게 설계된 부품이라고 할 수 있다.
- 제어장치는 클럭 신호를 받아들인다.
  - 클럭: 컴퓨터의 모든 부품을 일사불란하게 움직일 수 있게 하는 시간 단위
  - 컴퓨터의 모든 부품은 클럭의 주기에 맞춰 작동한다.
  - 단 한 클럭마다 작동한다는 뜻은 아니다. 하나의 명령어가 여러 클럭에 걸쳐 실행될 수 있다.
- 제어장치는 '해석해야 할 명령어'를 받아들인다.
  - CPU가 해석해야 할 명령어는 명령어 레지스터라는 특별한 레지스터에 저장된다.
  - 제어장치는 이 명령어 레지스터로부터 해석할 명령어를 받아들이고 해석한 뒤, 제어 신호를 발생시켜 컴퓨터 부품들에 수행해야 할 내용을 알려준다.
- 제어장치는 플래그 레지스터 속 플래그 값을 받아들인다.
- 제어장치는 시스템 버스, 그중에서 제어 버스로 전달된 제어 신호를 받아들인다.
  - 제어 신호는 CPU를 비롯해 입출력장치 등 CPU 외부 장치도 발생시킬 수 있다.
  - 제어장치는 제어 버스를 통해 외부로부터 전달된 제어 신호를 받아들이기도 한다.
- 제어장치는 제어신호를 CPU 내외부에 전달한다.
- CPU 외부에 제어 신호를 전달한다는 말은 곧 제어 버스로 제어 신호를 내보낸다는 말과 같다.
  - 메모리에 전달하는 제어 신호와 입출력장치(보조기억장치 포함)에 전달하는 제어 신호가 있다.
- CPU 내부에 전달하는 제어 신호에는 크게 ALU에 전달하는 제어 신호와 레지스터에 전달하는 제어신호가 있다.
  - ALU에는 수행할 연산을 지시하기 위해 제어 신호를 전달한다.
  - 레지스터에는 레지스터 간 데이터를 이동시키거나 레지스터에 저장된 명령어를 해석하기 위해 제어 신호를 전달한다.

## 4-2. 레지스터

### 반드시 알아야 할 레지스터

- 많은 CPU가 공통으로 포함하는 여덟개의 레지스터는 다음과 같다.
  1. 프로그램 카운터
  2. 명령어 레지스터
  3. 메모리 주소 레지스터
  4. 메모리 버퍼 레지스터
  5. 플래그 레지스터
  6. 범용 레지스터
  7. 스택 포인터
  8. 베이스 레지스터

#### 프로그램 카운터

- 메모리에서 가져올 명령어의 주소, 즉 메모리에서 읽어 들일 명령어의 주소를 저장한다.
  - 명령어 포인터라고 부르기도 한다.

#### 명령어 레지스터

- 해석할 명령어, 즉 방금 메모리에서 읽어 들인 명령어를 저장한다.

#### 메모리 주소 레지스터

- 메모리의 주소를 저장한다.

#### 메모리 버퍼 레지스터

- 메모리와 주고받을 값(데이터와 명령어)을 저장한다.

#### 범용 레지스터

- 다양하고 일반적인 상황에서 자유롭게 사용할 수 있다.

#### 플래그 레지스터

- 연산 결과 또는 CPU 상태에 대한 부가적인 정보를 저장한다.

### 특정 레지스터를 이용한 주소 지정 방식(1): 스택 주소 지정 방식

- 프로그램 카운터, 스택 포인터, 베이스 레지스터는 주소 지정에 사용될 수 있다.
  - 스택 포인터는 스택 주소 지정 방식에 사용되고, 프로그램 카운터와 베이스 레지스터는 변위 주소 지정 방식에 사용된다.
- 스택 포인터: 스택의 꼭대기를 가리키는 레지스터
- 스택은 메모리 안의 스택처럼 사용하기로 암묵적으로 약속된 영역인 스택 영역에 있다.

### 특정 레지스터를 이용한 주소 지정 방식(2): 변위 주소 지정 방식

- 오퍼랜드 필드의 값(변위)과 특정 레지스터의 값을 더하여 유효 주소를 얻어내는 주소 지정 방식
  - 그래서 변위 주소 지정 방식을 사용하는 명령어는 연산 코드 필드, 레지스터 필드, 오퍼랜드 필드가 있다.
- 오퍼랜드 필드의 주소와 어떤 레지스터를 더하는지에 따라 상대 주소 지정 방식, 베이스 레지스터 주소 지정 방식 등으로 나뉜다.

#### 상대 주소 지정 방식

- 오퍼랜드와 프로그램 카운터의 값을 더하여 유효 주소를 얻는 방식
- 프로그래밍 언어의 `if` 문과 유사하게, 분기하여 특정 주소의 코드를 실행할 때 사용된다

#### 베이스 레지스터 주소 지정 방식

- 오퍼랜드와 베이스 레지스터의 값을 더하여 유효 주소를 얻는 방식
- 베이스 레지스터는 '기준 주소', 오퍼랜드는 '기준 주소로부터 떨어진 거리'로서의 역할을 한다.

## 4-3. 명령어 사이클과 인터럽트

- 명령어 사이클: 하나의 명령어를 처리하는 정형화된 흐름
- 인터럽트: 명령어를 처리하는 정해진 흐름이 끊어지는 상황

### 명령어 사이클

- 프로그램 속 각각의 명령어들이 반복되며 실행되는 일정한 주기
- 인출 사이클: 메모리에 있는 명령어를 CPU로 가지고 오는 단계
- 실행 사이클: CPU로 가져온 명령어를 실행하는 단계
- 간접 사이클: 명령어를 실행하기 위해 추가로 메모리 접근을 하는 단계
  - 간접 주소 지정 방식과 같이, 오퍼랜드 필드에 유효 주소의 주소를 명시하는 경우

### 인터럽트

- CPU의 작업을 방해하는 신호
- 동기 인터럽트: CPU에 의해 발생하는 인터럽트
  - 예외*exception*라고도 부른다.
- 비동기 인터럽트: 주로 입출력장치에 의해 발생하는 인터럽트
  - 작업을 끝내는 입출력장치가 완료 알림(인터럽트)를 보내는 경우
  - 키보드, 마우스 등의 입출력장치가 입력을 받아들였을 때 입력 알림(인터럽트)를 보내는 경우
  - 하드웨어 인터럽트라고도 부른다.

#### 하드웨어 인터럽트

- CPU는 입출력 작업 도중에도 효율적으로 명령어를 처리하기 위해 알림과 같은 하드웨어 인터럽트를 사용한다.
- 입출력장치는 CPU보다 느리므로, 하드웨어 인터럽트를 사용하지 않는다면 CPU는 입출력장치가 언제 작업을 마칠지 알 수 없다. 따라서 주기적으로 작업 완료 여부를 확인해야 한다.
  - 하드웨어 인터럽트를 사용하면 알림을 받을 때까지 다른 작업을 처리할 수 있다.

#### 하드웨어 인터럽트 처리 순서

1. 입출력장치는 CPU에 **인터럽트 요청 신호**를 보낸다.
2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 확인한다.
3. CPU는 인터럽트 요청을 확인하고 **인터럽트 플래그**를 통해 현재 인터럽트를 받아들일 수 있는지 여부를 확인한다.
4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업한다.
5. CPU는 **인터럽트 벡터**를 참조하여 **인터럽트 서비스 루틴**을 실행한다.
6. 인터럽트 서비스 루틴 실행이 끝나면 4.에서 백업해둔 작업을 복구하여 실행을 재개한다.

- 인터럽트 요청 신호: 인터럽트하기 전 가능 여부를 묻는 신호
- 인터럽트 플래그: 하드웨어 인터럽트를 받아들일지, 무시할지를 결정하는 플래그
  - 불가능으로 설정되어 있다면 CPU는 인터럽트 요청을 무시한다.
  - 하지만 정전, 하드웨어 고장 등의 인터럽트 등 막을 수 없는 인터럽트도 있다.
- 인터럽트 서비스 루틴: 인터럽트를 처리하기 위한 프로그램
  - 인터럽트 핸들러라고도 부른다.
  - 어떤 인터럽트가 발생했을 때 해당 인터럽트를 어떻게 처리하고 작동해야 할지에 대한 정보로 이루어진 프로그램이다.
  - 메모리에는 여러 개의 인터럽트 서비스 루틴이 저장되어 있다.
- 인터럽트 벡터: 인터럽트 서비스 루틴을 식별하기 위한 정보

- `CPU가 인터럽트를 처리한다` = `인터럽트 서비스 루틴을 실행하고, 본래 수행하던 작업으로 다시 되돌아 온다.`
- 인터럽트 서비스 루틴 역시 명령어와 데이터로 이루어져 있고, 프로그램 카운터를 비롯한 레지스터들을 사용하며 실행된다.
- 인터럽트가 발생하기 전까지 레지스터에 저장되어 있던 프로그램 카운터 값 등을 스택에 백업한다.

### 예외의 종류

- 예외가 발생하면 CPU는 하던 일을 중단하고 해당 예외를 처리한다.
  - 예외를 처리하고 본래 하던 작업으로 돌아왔을 때, 예외가 발생한 명령어부터 실행하느냐, 예외가 발생한 명령어 다음 명령어부터 실행하느냐에 따라 폴트와 트랩으로 나뉜다.
- 폴트: 예외를 처리한 직후 예외가 발생한 명령어부터 실행을 재개하는 예외
- 트랩: 예외를 처리한 직후 예외가 발생한 명령어의 다음 명령어부터 실행을 재개하는 예외
  - 주로 디버깅할 때 사용한다.
- 중단: CPU가 실행 중인 프로그램을 강제로 중단시킬 수밖에 없는 심각한 오류를 발견했을 때 발생하는 예외
- 소프트웨어 인터럽트: 시스템 호출이 발생했을 때 나타난다
