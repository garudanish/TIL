# Chapter 05. CPU 성능 향상 기법

## 5-1. 빠른 CPU를 위한 설계 기법

### 클럭

- 클럭 속도가 높아지면 CPU는 명령어 사이클을 더 빠르게 반복할 것이고, 다른 부품들도 그에 맞춰 더 빠르게 작동한다.
- 클럭 속도가 높은 CPU는 일반적으로 성능이 좋다.
- 클럭 속도는 헤르츠(Hz) 단위로 측정한다.
- 클럭 속도를 무작정 높이면 발열 문제가 심해진다.
- 클럭 속도를 높이는 것은 CPU를 빠르게 만들 수 있지만, 클럭 속도만으로 CPU를 올리는 것에는 한계가 있다.

### 코어와 멀티 코어

- CPU의 성능을 높이는 방법에는 CPU의 코어와 스레드 수를 늘리는 방법이 있다.
- CPU의 정의로 소개했던 '명령어를 실행하는 부품'은 오늘날 코어라는 용어로 사용된다.
  - CPU의 정의는 '명령어를 실행하는 부품'에서 '명령어를 실행하는 부품을 여러 개 포함하는 부품'으로 범위가 확장되었다.
- 코어를 여러 개 포함하는 CPU를 멀티코어 CPU 또는 멀티코어 프로세서라고 부른다.
- 코어마다 처리할 연산이 적절이 분배되지 않는다면 코어 수에 비례해 연산 속도가 증가하지 않는다.
- 처리하고자 하는 작업량보다 코어 수가 지나치게 많아도 성능에는 크게 영향이 없다.
- 코어마다 처리할 명령어들을 얼마나 적절하게 분배하느냐가 중요하고, 그에 따라 연산 속도가 크게 달라진다.

### 스레드와 멀티스레드

- 스레드의 사전적 의미: 실행 흐름의 단위
- CPU에서 사용되는 하드웨어적 스레드, 프로그램에서 사용되는 소프트웨어적 스레드가 있다.

#### 하드웨어적 스레드

- 스레드의 하드웨어적 정의: 하나의 코어가 동시에 처리하는 명령어 단위
- 여러 스레드를 지원하는 CPU는 하나의 코어로도 여러 개의 명령어를 동시에 실행할 수 있다.
- 하나의 코어로 여러 명령어를 동시에 처리하는 CPU를 멀티스레드 프로세서 또는 멀티스레드 CPU라고 한다.
- 인텔은 자신들의 멀티스레드 기술을 하이퍼스레딩이라고 부른다.

#### 소프트웨어적 스레드

- 스레드의 소프트웨어적 정의: 하나의 프로그램에서 독립적으로 실행되는 단위
- 1코어 1스레드 CPU도 소프트웨어적 스레드를 수십 개 실행할 수 있다.

#### 멀티스레드 프로세서

- 멀티스레드 프로세서의 가장 큰 핵심은 레지스터다.
- 하나의 명령어를 처리하기 위해 꼭 필요한 레지스터를 여러 개 가지고 있으면 하나의 코어로 여러 명령어를 동시에 처리할 수 있다.
- 프로그램 입장에선 2코어가 각각 스레드를 2개씩 갖고 있는 것과 4코어가 각각 스레드를 1개씩 갖고 있는 것과 다를 바가 없다. 그래서 하드웨어 스레드를 논리 프로세서라고 부르기도 한다.

## 5-2. 명령어 병렬 처리 기법

### 명령어 파이프라인

- 명령어 처리 과정을 클럭 단위로 나누어 보면 다음과 같이 나눌 수 있다.
  - 1) 명령어 인출
  - 2) 명령어 해석
  - 3) 명령어 실행
  - 4) 결과 저장
- 같은 단계가 겹치지만 않는다면 CPU는 각 단계를 동시에 실행할 수 있다.
- CPU가 한 명령어를 인출하는 동안에 다른 명령어를 실행할 수 있다. 한 명령어를 실행하는 동안에 연산 결과를 저장할 수 있다.
- 이렇게 명령어를 명령어 파이프라인에 넣고 동시에 처리하는 기법을 명령어 파이프라이닝이라고 한다.
- 파이프라이닝은 높은 성능을 가져오긴 하지만, 특정 상황에서는 성능 향상에 실패하는 경우도 있다. 이를 파이프라인 위험이라고 한다.
  - 파이프라인 위험에는 크게 데이터 위험, 제어 위험, 구조적 위험이 있다.

#### 데이터 위험

- 명령어 간 데이터 의존성에 의해 발생한다.
- 이전 명령어를 끝까지 수행해야만 다음 명령어를 수행할 수 있는데, 동시에 실행하려고 하면 파이프라인이 제대로 작동하지 않는다

#### 제어 위험

- 분기 등으로 인한 프로그램 카운터의 갑작스러운 변화에 의해 발생한다.
- 프로그램 카운터 값에 갑작스러운 변화가 생긴다면 미리 가지고 와서 처리 중인 명령어가 쓸모 없어진다.
- 제어 위험을 위해 사용하는 기술 중 하나가 분기 예측이다.
  - 프로그램이 어디로 분기할지 미리 예측한 후 그 주소를 인출하는 기술이다.

#### 구조적 위험

- 명령어들을 겹쳐 실행하는 과정에서 서로 다른 명령어가 동시에 ALU, 레지스터 등과 같은 CPU 부품을 사용하려고 할 때 발생한다.
- 자원 위험이라고도 부른다.

### 슈퍼스칼라

- CPU 내부에 여러 개의 명령어 파이프라인을 포함한 구조를 슈퍼스칼라라고 한다.
- 슈퍼스칼라 구조로 명령어 처리가 가능한 CPU를 슈퍼스칼라 프로세서 또는 슈퍼스칼라 CPU라고 한다.
- 이론적으로 파이프라인 개수에 비례하여 프로그램 처리 속도가 빨라지지만, 파이프라인 위험 등의 문제가 있어 반드시 비례해 빨라지진 않는다.

### 비순차적 명령어 처리

- OoOE로 줄여 부른다. Out-of-order execution.
- 명령어 파이프라이닝, 슈퍼스칼라 기법은 모두 여러 명령어의 순차적인 처리를 상정한 방법이다.
- 모든 명령어를 순차적으로만 처리하면 예상치 못한 상황에서 명령어 파이프라인이 멈추게 된다.
- 명령어를 순차적으로만 실행하지 않고, 순서를 바꿔 실행해도 무방한 명령어를 먼저 실행해 명령어 파이프라인이 멈추는 것을 방지하는 기법이다.
- 명령어 간 의존성이 없는 명령어 끼리만 순서를 바꾸어 실행할 수 있다.
- 비순차적 명령어 처리가 가능한 CPU는 명령어들이 어떤 명령어와 데이터 의존성을 가지고 있는지, 순서를 바꿔 실행할 수 있는 명령어에는 어떤 것들이 있는지를 판단할 수 있어야 한다.
